<!DOCTYPE html>
<html>
<head>
    <title>Embedded Python IDE</title>
    <!-- Brython -->
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython_stdlib.js"></script>
    <!-- CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        .python-ide-widget {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }

        .ide-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .editor-section {
            background: white;
            border-radius: 6px;
            padding: 10px;
        }

        .output-section {
            background: white;
            border-radius: 6px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .CodeMirror {
            height: 300px;
            border-radius: 4px;
            font-size: 14px;
        }

        .canvas-container {
            width: 100%;
            aspect-ratio: 1;
            background: #2c2c2c;
            border-radius: 4px;
            overflow: hidden;
        }

        #output-console {
            background: #2c2c2c;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        button {
            background: #6200ee;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover {
            background: #3700b3;
        }

        button.secondary {
            background: #03dac6;
        }

        button.secondary:hover {
            background: #018786;
        }
    </style>
    <script>
        window.addEventListener('load', function() {
            brython({debug: 1});
        });
    </script>
</head>
<body>
    <!-- Container for the IDE -->
    <div id="my-python-ide">
        <div class="python-ide-widget">
            <div class="ide-container">
                <!-- Editor Section -->
                <div class="editor-section">
                    <div>Python Code</div>
                    <textarea id="code-editor"></textarea>
                    <div class="controls">
                        <button id="run-btn">Run Code</button>
                        <button id="reset-btn" class="secondary">Reset</button>
                    </div>
                </div>
                
                <!-- Output Section -->
                <div class="output-section">
                    <div>Animation</div>
                    <div class="canvas-container">
                        <canvas id="animation-canvas" width="400" height="400"></canvas>
                    </div>
                    <div>Console Output</div>
                    <div id="output-console"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/python">
from browser import document, window, html
import javascript
import sys
import traceback

class PythonIDE:
    def __init__(self):
        self.setup_ide()
        self.setup_brython_console()
        
    def setup_ide(self):
        # Initialize CodeMirror
        self.setup_codemirror()
        
        # Bind event handlers
        document["run-btn"].bind("click", self.run_code)
        document["reset-btn"].bind("click", self.reset_code)
        
    def setup_codemirror(self):
        self.editor = window.CodeMirror.fromTextArea(
            document["code-editor"],
            {
                "mode": "python",
                "theme": "monokai",
                "lineNumbers": True,
                "autoCloseBrackets": True,
                "matchBrackets": True,
                "indentUnit": 4,
                "tabSize": 4,
                "indentWithTabs": False,
                "extraKeys": {"Tab": "indentMore", "Shift-Tab": "indentLess"},
            }
        )
        
        # Set initial code
        self.initial_code = """# Simple bouncing ball animation
import math
from browser import window, timer

# Get canvas context
canvas = document["animation-canvas"]
ctx = canvas.getContext('2d')

# Ball properties
x = 200  # Starting x position
y = 200  # Starting y position
dx = 5   # X velocity
dy = 5   # Y velocity
radius = 20

def draw_frame():
    # Clear canvas
    ctx.clearRect(0, 0, 400, 400)
    
    # Draw ball
    ctx.beginPath()
    ctx.arc(x, y, radius, 0, 2 * math.pi)
    ctx.fillStyle = '#4CAF50'
    ctx.fill()
    ctx.closePath()

def update_position():
    global x, y, dx, dy
    
    # Update position
    x += dx
    y += dy
    
    # Check boundaries
    if x + radius > 400 or x - radius < 0:
        dx *= -1
    if y + radius > 400 or y - radius < 0:
        dy *= -1

def animate(time):
    update_position()
    draw_frame()
    # Request next frame
    timer.request_animation_frame(animate)

print("Starting animation...")
# Start animation loop
timer.request_animation_frame(animate)
"""
        self.editor.setValue(self.initial_code)
        
    def setup_brython_console(self):
        def write_console(text):
            console = document["output-console"]
            console.text = console.text + str(text)
            console.scrollTop = console.scrollHeight
            
        sys.stdout.write = write_console
        sys.stderr.write = write_console
        
    def run_code(self, evt=None):
        try:
            # Clear output
            document["output-console"].text = ""
            print("Starting code execution...")
            
            # Clear canvas
            canvas = document["animation-canvas"]
            ctx = canvas.getContext('2d')
            ctx.clearRect(0, 0, 400, 400)
            print("Canvas cleared...")
            
            # Get code from editor
            code = self.editor.getValue()
            print("Got code from editor...")
            
            # Add canvas to namespace
            namespace = {
                'canvas': canvas,
                'document': document,
                'window': window,
                'javascript': javascript
            }
            print("Namespace prepared...")
            
            # Execute code
            print("Executing code...")
            exec(code, namespace)
            print("Code executed successfully!")
            
        except Exception as e:
            print(f"Error during execution: {str(e)}")
            traceback.print_exc(file=sys.stdout)
            
    def reset_code(self, evt=None):
        self.editor.setValue(self.initial_code)
        document["output-console"].text = ""
        
        # Clear canvas
        canvas = document["animation-canvas"]
        ctx = canvas.getContext('2d')
        ctx.clearRect(0, 0, 400, 400)

# Initialize IDE
ide = PythonIDE()
    </script>
</body>
</html>
